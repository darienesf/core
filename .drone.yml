---
kind: pipeline
name: install-dependencies

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: cache-rebuild
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - .cache
    rebuild: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    event:
    - push
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: cache-flush
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    flush: true
    flush_age: 14
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    event:
    - push
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

---
kind: pipeline
name: coding-standard

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: test
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-style

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: phan-php7.1

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-phan

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: stan-php7.1

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-phpstan

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: test-javascript

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-js

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiMain

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiMain
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiAuth

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiAuth
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiAuthOcs

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiAuthOcs
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiCapabilities

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiCapabilities
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiComments

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiComments
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiFavorites

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiFavorites
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiFederation

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiFederation
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiProvisioning-v1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiProvisioning-v1
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiProvisioning-v2

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiProvisioning-v2
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiProvisioningGroups-v1

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiProvisioningGroups-v1
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiProvisioningGroups-v2

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiProvisioningGroups-v2
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiSharees

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiSharees
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiShareManagement

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiShareManagement
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiShareManagementBasic

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiShareManagementBasic
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiShareOperations

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiShareOperations
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiShareReshare

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiShareReshare
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiShareUpdate

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiShareUpdate
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiSharingNotifications

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: install-notifications-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/notifications.git apps/notifications
  - php occ a:e notifications

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiSharingNotifications
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiTags

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiTags
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiTrashbin

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiTrashbin
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiVersions

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiVersions
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiWebdavLocks

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavLocks
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiWebdavLocks2

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavLocks2
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiWebdavMove

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavMove
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiWebdavOperations

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavOperations
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiWebdavProperties

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavProperties
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-apiWebdavUpload

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavUpload
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-cliAppManagement

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make
  - su-exec www-data ./tests/acceptance/run.sh --type cli
  environment:
    BEHAT_SUITE: cliAppManagement
    MAILHOG_HOST: email
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-cliProvisioning

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: cliProvisioning
    MAILHOG_HOST: email
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-cliMain

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: cliMain
    MAILHOG_HOST: email
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-cliBackground

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: cliBackground
    MAILHOG_HOST: email
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-cliTrashbin

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: cliTrashbin
    MAILHOG_HOST: email
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIAdminSettings

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIAdminSettings
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIComments

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIComments
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUICreateDelete

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUICreateDelete
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIFavorites

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIFavorites
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIFiles

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIFiles
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUILogin

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUILogin
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIMoveFilesFolders

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIMoveFilesFolders
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIPersonalSettings

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIPersonalSettings
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIRenameFiles

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIRenameFiles
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIRenameFolders

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIRenameFolders
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIRestrictSharing

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIRestrictSharing
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUISharingAcceptShares

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingAcceptShares
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUISharingAutocompletion

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingAutocompletion
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUISharingExternal

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingExternal
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUISharingInternalGroups

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingInternalGroups
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUISharingInternalUsers

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingInternalUsers
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUISharingNotifications

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: install-notifications-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/notifications.git apps/notifications
  - php occ a:e notifications

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingNotifications
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUISharingPublic

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingPublic
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUITags

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUITags
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUITrashbin

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUITrashbin
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIUpload

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIUpload
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIWebdavLocks

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIWebdavLocks
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-chrome-webUIWebdavLockProtection

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIWebdavLockProtection
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: chrome
  pull: always
  image: selenium/standalone-chrome-debug:3.141.59-oxygen
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-firefox-smokeTest-1/3

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-http
  - php occ config:system:set trusted_domains 2 --value=federated-http
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BROWSER: firefox
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: firefox
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server-http

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-http
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: firefox
  pull: always
  image: selenium/standalone-firefox-debug:3.8.1
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING
    SE_OPTS: -enablePassThrough false

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-firefox-smokeTest-2/3

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-http
  - php occ config:system:set trusted_domains 2 --value=federated-http
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BROWSER: firefox
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: firefox
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server-http

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-http
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: firefox
  pull: always
  image: selenium/standalone-firefox-debug:3.8.1
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING
    SE_OPTS: -enablePassThrough false

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: behat-firefox-smokeTest-3/3

platform:
  os: linux
  arch: amd64

workspace:
  base: /drone
  path: src

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-http
  - php occ config:system:set trusted_domains 2 --value=federated-http
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BROWSER: firefox
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: firefox
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server-http

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-http
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

- name: firefox
  pull: always
  image: selenium/standalone-firefox-debug:3.8.1
  environment:
    JAVA_OPTS: -Dselenium.LOGGER.level=WARNING
    SE_OPTS: -enablePassThrough false

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: caldav-php7.1-mariadb

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: caldav-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/caldav/install.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: caldav-test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/caldav/script.sh

services:
- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: carddav-php7.1-mariadb

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: carddav-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/carddav/install.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: carddav-test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/carddav/script.sh

services:
- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: caldav-old-endpoint-php7.1-mariadb

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: caldav-old-endpoint-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/caldav-old-endpoint/install.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: caldav-old-endpoint-test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/caldav-old-endpoint/script.sh

services:
- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: carddav-old-endpoint-php7.1-mariadb

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: carddav-old-endpoint-install
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/carddav-old-endpoint/install.sh

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: carddav-old-endpoint-test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - bash apps/dav/tests/ci/carddav-old-endpoint/script.sh

services:
- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: litmus

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:

- name: litmus-setup
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "echo \"Create local mount ....\""
  - mkdir -p /drone/src/work/local_storage
  - php occ app:enable files_external
  - php occ config:system:set files_external_allow_create_new_local --value=true
  - php occ config:app:set core enable_external_storage --value=yes
  - php occ files_external:create local_storage local null::null -c datadir=/drone/src/work/local_storage
  - "echo \"Sharing a folder ..\""
  - OC_PASS=123456 php occ user:add --password-from-env user1
  - chown www-data /drone/src -R
  - "curl -k -s -u user1:123456 -X MKCOL \"https://server-https/remote.php/webdav/new_folder\""
  - "curl -k -s -u user1:123456 \"https://server-https/ocs/v2.php/apps/files_sharing/api/v1/shares\" --data 'path=/new_folder&shareType=0&permissions=15&name=new_folder&shareWith=admin'"

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - "chown www-data \"/drone/src\" -R"

- name: owncloud-log
  pull: always
  image: owncloud/ubuntu:16.04
  detach: true
  commands:
  - "tail -f \"/drone/src/data/owncloud.log\""
  when:
    status:
    - success
    - failure

- name: litmus-old-endpoint
  pull: always
  image: owncloud/litmus
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_URL: https://server-https/remote.php/webdav
    LITMUS_USERNAME: admin

- name: litmus-new-endpoint
  pull: always
  image: owncloud/litmus
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_URL: https://server-https/remote.php/dav/files/admin
    LITMUS_USERNAME: admin

- name: litmus-new-endpoint-mount
  pull: always
  image: owncloud/litmus
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_URL: https://server-https/remote.php/dav/files/admin/local_storage/
    LITMUS_USERNAME: admin

- name: litmus-old-endpoint-mount
  pull: always
  image: owncloud/litmus
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_URL: https://server-https/remote.php/webdav/local_storage/
    LITMUS_USERNAME: admin

- name: litmus-new-endpoint-shared
  pull: always
  image: owncloud/litmus
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_URL: https://server-https/remote.php/dav/files/admin/new_folder/
    LITMUS_USERNAME: admin

- name: litmus-old-endpoint-shared
  pull: always
  image: owncloud/litmus
  environment:
    LITMUS_PASSWORD: admin
    LITMUS_URL: https://server-https/remote.php/webdav/new_folder/
    LITMUS_USERNAME: admin

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

...
