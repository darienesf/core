---
kind: pipeline
name: install-dependencies

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: cache-rebuild
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    mount:
    - .cache
    rebuild: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    event:
    - push
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: cache-flush
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    flush: true
    flush_age: 14
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    event:
    - push
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

---
kind: pipeline
name: coding-standard

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: test
  pull: always
  image: owncloudci/php:7.3
  commands:
  - make test-php-style

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: phan-php7.1

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-phan

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: stan-php7.1

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-php-phpstan

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- install-dependencies

---
kind: pipeline
name: test-javascript

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make test-js

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-mariadb10.3

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: mariadb
  image: mariadb:10.3
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-mysql5.5

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mysql

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: mysql
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-mysql5.7

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mysql

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: mysql
  image: mysql:5.7
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-mysql8.0

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mysql

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: mysql
  image: mysql:8.0
  command:
  - --default-authentication-plugin=mysql_native_password
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-postgres9.4

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: postgres

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: postgres
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-postgres10.3

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: postgres

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: postgres
  image: postgres:10.3
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-oracle

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: oracle

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: oracle
  image: deepdiver/docker-oracle-xe-11g:2.0
  environment:
    ORACLE_DISABLE_ASYNCH_IO: true

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-sqlite

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.2-mariadb10.3

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.2
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: mariadb
  image: mariadb:10.3
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.2-mysql5.5

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mysql

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.2
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: mysql
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.2-postgres9.4

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: postgres

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.2
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: postgres
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.2-sqlite

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.2
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.2
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.2
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.3-mariadb10.3

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.3
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.3
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.3
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: mariadb
  image: mariadb:10.3
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.3-mysql5.5

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.3
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mysql

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.3
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.3
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: mysql
  image: mysql:5.5
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.3-postgres9.4

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.3
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: postgres

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.3
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.3
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
- name: postgres
  image: postgres:9.4
  environment:
    POSTGRES_DB: owncloud
    POSTGRES_PASSWORD: owncloud
    POSTGRES_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.3-sqlite

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.3
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.3
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.3
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true

services:
trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-mariadb10.3-webdav

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    FILES_EXTERNAL_TYPE: webdav_apache

services:
- name: apache-webdav
  pull: always
  image: owncloudci/php
  command:
  - /usr/local/bin/apachectl
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: webdav

- name: mariadb
  image: mariadb:10.3
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-mariadb10.3-samba

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    FILES_EXTERNAL_TYPE: smb_samba

services:
- name: smb-samba
  pull: always
  image: owncloudci/samba
  command:
  - -u
  - test;test
  - -s
  - public;/tmp;yes;no;no;test;none;test
  - -S

- name: mariadb
  image: mariadb:10.3
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-mariadb10.3-windows

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    FILES_EXTERNAL_TYPE: windows

services:
- name: mariadb
  image: mariadb:10.3
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-mariadb10.3-swift-external

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    FILES_EXTERNAL_TYPE: swift

services:
- name: ceph
  pull: always
  image: owncloudci/ceph
  environment:
    KEYSTONE_ADMIN_PASS: testing
    KEYSTONE_ADMIN_TENANT: testtenant
    KEYSTONE_ADMIN_USER: test
    KEYSTONE_ENDPOINT_REGION: testregion
    KEYSTONE_PUBLIC_PORT: 5034
    KEYSTONE_SERVICE: testceph
    OSD_SIZE: 500

- name: mariadb
  image: mariadb:10.3
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-mariadb10.3-swift-objectstore

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: prepare-objectstore
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /drone/src/apps
  - git clone https://github.com/owncloud/files_primary_s3.git
  - cd files_primary_s3
  - composer install
  - cp tests/drone/swift.config.php /drone/src/config
  - cd /drone/src
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:l
  - php ./occ s3:create-bucket owncloud --accept-warning
  environment:
    OBJECTSTORE: swift

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    FILES_EXTERNAL_TYPE: swift
    PRIMARY_OBJECTSTORE: swift

services:
- name: ceph
  pull: always
  image: owncloudci/ceph
  environment:
    KEYSTONE_ADMIN_PASS: testing
    KEYSTONE_ADMIN_TENANT: testtenant
    KEYSTONE_ADMIN_USER: test
    KEYSTONE_ENDPOINT_REGION: testregion
    KEYSTONE_PUBLIC_PORT: 5034
    KEYSTONE_SERVICE: testceph
    OSD_SIZE: 500

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: phpunit-php7.1-sqlite-files_primary_s3-scality

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: sqlite

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: prepare-objectstore
  pull: always
  image: owncloudci/php:7.1
  commands:
  - cd /drone/src/apps
  - git clone https://github.com/owncloud/files_primary_s3.git
  - cd files_primary_s3
  - composer install
  - cp tests/drone/scality.config.php /drone/src/config
  - cd /drone/src
  - php occ a:l
  - php occ a:e files_primary_s3
  - php occ a:l
  - php ./occ s3:create-bucket owncloud --accept-warning
  environment:
    OBJECTSTORE: scality

- name: test
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/test-phpunit.sh
  environment:
    COVERAGE: true
    PRIMARY_OBJECTSTORE: files_primary_s3

services:
- name: scality
  pull: always
  image: owncloudci/scality-s3server
  environment:
    HOST_NAME: scality

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiMain

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiMain
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiAuth

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiAuth
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiAuthOcs

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiAuthOcs
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiCapabilities

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiCapabilities
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiComments

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiComments
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiFavorites

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiFavorites
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiFederation

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiFederation
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiProvisioning-v1

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiProvisioning-v1
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiProvisioning-v2

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiProvisioning-v2
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiProvisioningGroups-v1

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiProvisioningGroups-v1
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiProvisioningGroups-v2

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiProvisioningGroups-v2
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiSharees

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiSharees
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiShareManagement

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiShareManagement
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiShareManagementBasic

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiShareManagementBasic
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiShareOperations

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiShareOperations
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiShareReshare

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiShareReshare
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiShareUpdate

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiShareUpdate
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiSharingNotifications

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiSharingNotifications
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiTags

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiTags
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiTrashbin

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiTrashbin
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiVersions

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiVersions
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiWebdavLocks

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavLocks
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiWebdavLocks2

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavLocks2
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiWebdavMove

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavMove
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiWebdavOperations

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavOperations
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiWebdavProperties

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavProperties
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-apiWebdavUpload

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: api-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-api TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: apiWebdavUpload
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-cliAppManagement

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make
  - su-exec www-data ./tests/acceptance/run.sh --type cli
  environment:
    BEHAT_SUITE: cliAppManagement
    MAILHOG_HOST: email
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-cliProvisioning

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: cliProvisioning
    MAILHOG_HOST: email
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-cliMain

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: cliMain
    MAILHOG_HOST: email
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-cliBackground

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: cliBackground
    MAILHOG_HOST: email
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-cliTrashbin

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-cli TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: cliTrashbin
    MAILHOG_HOST: email
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIAdminSettings

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIAdminSettings
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIComments

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIComments
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUICreateDelete

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUICreateDelete
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIFavorites

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIFavorites
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIFiles

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIFiles
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUILogin

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUILogin
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIMoveFilesFolders

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIMoveFilesFolders
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIPersonalSettings

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIPersonalSettings
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIRenameFiles

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIRenameFiles
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIRenameFolders

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIRenameFolders
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIRestrictSharing

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIRestrictSharing
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUISharingAcceptShares

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingAcceptShares
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUISharingAutocompletion

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingAutocompletion
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUISharingExternal

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingExternal
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUISharingInternalGroups

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingInternalGroups
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUISharingInternalUsers

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingInternalUsers
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUISharingNotifications

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingNotifications
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUISharingPublic

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUISharingPublic
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUITags

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUITags
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUITrashbin

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUITrashbin
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIUpload

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIUpload
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIWebdavLocks

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIWebdavLocks
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-chrome-webUIWebdavLockProtection

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BEHAT_SUITE: webUIWebdavLockProtection
    BROWSER: chrome
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: chrome
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: https://server-https

services:
- name: server-https
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_CONFIG_TEMPLATE: ssl
    APACHE_SSL_CERT: /drone/server.crt
    APACHE_SSL_CERT_CN: server-https
    APACHE_SSL_KEY: /drone/server.key
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-firefox-smokeTest-1/3

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BROWSER: firefox
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: firefox
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server-http

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-http
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-firefox-smokeTest-2/3

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BROWSER: firefox
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: firefox
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server-http

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-http
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

---
kind: pipeline
name: behat-firefox-smokeTest-3/3

platform:
  os: linux
  arch: amd64

steps:
- name: cache-restore
  pull: always
  image: plugins/s3-cache:1
  settings:
    access_key:
      from_secret: cache_s3_access_key
    endpoint:
      from_secret: cache_s3_endpoint
    restore: true
    secret_key:
      from_secret: cache_s3_secret_key
  when:
    instance:
    - drone.owncloud.services
    - drone.owncloud.com

- name: composer
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-composer-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: vendorbin
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make vendor-bin-deps
  environment:
    COMPOSER_HOME: /drone/src/.cache/composer

- name: yarn
  pull: always
  image: owncloudci/php:7.1
  commands:
  - make install-nodejs-deps
  environment:
    NPM_CONFIG_CACHE: /drone/src/.cache/npm
    YARN_CACHE_FOLDER: /drone/src/.cache/yarn
    bower_storage__packages: /drone/src/.cache/bower

- name: install-server
  pull: always
  image: owncloudci/php:7.1
  commands:
  - ./tests/drone/install-server.sh
  - php occ a:l
  - php occ config:system:set trusted_domains 1 --value=server-https
  - php occ config:system:set trusted_domains 2 --value=federated-https
  - php occ log:manage --level 2
  - php occ config:list
  - php occ security:certificates:import /drone/server.crt
  - php occ security:certificates:import /drone/federated.crt
  - php occ security:certificates
  environment:
    DB_TYPE: mariadb

- name: install-testing-app
  pull: always
  image: owncloudci/php:7.1
  commands:
  - git clone https://github.com/owncloud/testing.git $$DRONE_WORKSPACE/apps-external/testing
  - php occ a:l
  - php occ a:e testing
  - php occ a:l

- name: fix-permissions
  pull: always
  image: owncloudci/php:7.1
  commands:
  - chown www-data /drone/src -R

- name: cli-acceptance-tests
  pull: always
  image: owncloudci/php:7.1
  commands:
  - touch /drone/saved-settings.sh
  - . /drone/saved-settings.sh
  - make test-acceptance-webui TESTING_REMOTE_SYSTEM=true
  environment:
    BROWSER: firefox
    MAILHOG_HOST: email
    PLATFORM: Linux
    SELENIUM_HOST: firefox
    SELENIUM_PORT: 4444
    TEST_SERVER_URL: http://server-http

services:
- name: email
  pull: always
  image: mailhog/mailhog

- name: server-http
  pull: always
  image: owncloudci/php:7.1
  command:
  - /usr/local/bin/apachectl
  - -e
  - debug
  - -D
  - FOREGROUND
  environment:
    APACHE_WEBROOT: /drone/src/

- name: mariadb
  image: mariadb:10.2
  environment:
    MYSQL_DATABASE: owncloud
    MYSQL_PASSWORD: owncloud
    MYSQL_ROOT_PASSWORD: owncloud
    MYSQL_USER: owncloud

trigger:
  ref:
  - refs/heads/master
  - refs/heads/stable10
  - refs/heads/drone-jsonnet
  - "refs/heads/release-*"
  - "refs/tags/**"
  - "refs/pull/**"

depends_on:
- coding-standard
- phan-php7.1
- stan-php7.1

...
